import os
import csv
import hashlib
import stat
from datetime import datetime

# Palabras clave sospechosas (comandos usados por malware o tareas en segundo plano)
SUSPICIOUS_KEYWORDS = [
    "CreateObject", "WScript.Shell", "PowerShell", "cmd.exe", "taskkill",
    "schtasks", "registry", "HKLM", "Startup", "RunOnce", "download", "Invoke-WebRequest",
    "base64", "system(", "subprocess", "exec(", "socket", "requests.get"
]

# Extensiones sospechosas de ejecución o scripting
SUSPICIOUS_EXTENSIONS = [
    ".exe", ".bat", ".cmd", ".vbs", ".js", ".ps1", ".scr", ".dll", ".jar"
]

def hash_file(filepath):
    """Genera hash SHA256 del archivo (útil para comparar o enviar a VirusTotal manualmente)."""
    try:
        with open(filepath, "rb") as f:
            return hashlib.sha256(f.read()).hexdigest()
    except Exception:
        return None

def analyze_file(filepath):
    """Analiza un archivo individual y devuelve indicadores de sospecha."""
    indicators = []
    ext = os.path.splitext(filepath)[1].lower()

    # 1. Revisa extensión sospechosa
    if ext in SUSPICIOUS_EXTENSIONS:
        indicators.append("Extensión sospechosa")

    # 2. Revisa tamaño anormal (archivos pequeños ejecutables suelen ser dropper)
    size = os.path.getsize(filepath)
    if size < 10 * 1024 and ext in [".exe", ".dll"]:
        indicators.append("Ejecutable muy pequeño")

    # 3. Busca palabras clave sospechosas en archivos de texto o scripts
    try:
        with open(filepath, "r", errors="ignore") as f:
            content = f.read()
            for kw in SUSPICIOUS_KEYWORDS:
                if kw.lower() in content.lower():
                    indicators.append(f"Comando sospechoso: {kw}")
                    break
    except:
        pass

    # 4. Revisa atributos del archivo (oculto o de sistema)
    try:
        attr = os.stat(filepath).st_file_attributes
        if attr & stat.FILE_ATTRIBUTE_HIDDEN:
            indicators.append("Archivo oculto")
    except:
        pass

    return indicators

def scan_directory(root_folder, output_csv="analisis_malware.csv"):
    """Escanea la carpeta y guarda un reporte CSV."""
    with open(output_csv, mode="w", newline="", encoding="utf-8") as file:
        writer = csv.writer(file)
        writer.writerow(["Archivo", "Hash SHA256", "Tamaño (KB)", "Fecha Modificación", "Indicadores"])

        for dirpath, _, filenames in os.walk(root_folder):
            for filename in filenames:
                filepath = os.path.join(dirpath, filename)
                indicators = analyze_file(filepath)
                if indicators:
                    writer.writerow([
                        filepath,
                        hash_file(filepath),
                        round(os.path.getsize(filepath) / 1024, 2),
                        datetime.fromtimestamp(os.path.getmtime(filepath)).strftime("%Y-%m-%d %H:%M"),
                        "; ".join(indicators)
                    ])
    print(f"\n✅ Análisis completo. Resultados guardados en: {output_csv}")

# --- Ejemplo de uso ---
if __name__ == "__main__":
    carpeta = input("Ruta de la carpeta a analizar: ").strip('"')
    scan_directory(carpeta)
